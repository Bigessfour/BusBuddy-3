<syncfusion:ChromelessWindow x:Class="BusBuddy.WPF.Views.Student.StudentsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:syncfusion="http://schemas.syncfusion.com/wpf"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="800"
             Title="Student Management"
             Height="600" Width="900"
             WindowStartupLocation="CenterOwner">

    <syncfusion:ChromelessWindow.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/BusBuddy.WPF;component/Resources/SyncfusionV30_Validated_ResourceDictionary.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <!-- Required converter for Visibility bindings -->
            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
            <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                <Setter Property="Margin" Value="5"/>
                <Setter Property="Padding" Value="10,5"/>
                <Setter Property="MinWidth" Value="80"/>
            </Style>
        </ResourceDictionary>
    </syncfusion:ChromelessWindow.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

    <!-- Header -->
    <Border Grid.Row="0" Background="{DynamicResource BusBuddy.Brush.Primary}"
                CornerRadius="5" Padding="15" Margin="0,0,0,10">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="&#xE716;" FontFamily="Segoe MDL2 Assets"
                          FontSize="24" Foreground="{DynamicResource BusBuddy.Brush.Text.Primary}" VerticalAlignment="Center" Margin="0,0,10,0"/>
                <TextBlock Text="Student Management" FontSize="20" FontWeight="Bold"
                          Foreground="{DynamicResource BusBuddy.Brush.Text.Primary}" VerticalAlignment="Center"/>
            </StackPanel>
        </Border>

    <!-- Enhanced Toolbar for Route Building -->
    <Border Grid.Row="1" Background="{DynamicResource BusBuddy.Brush.Surface.Light}"
                CornerRadius="3" Padding="10" Margin="0,0,0,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

        <!-- Main Actions — all Buttons must bind to ViewModel commands (verified below) -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
        <!-- Add student — always enabled. Command: AddStudentCommand -->
        <syncfusion:ButtonAdv Name="AddStudentButton" Label="➕ Add Student"
                            Command="{Binding AddStudentCommand}"
                Background="{DynamicResource BusBuddy.Brush.Primary}" Foreground="{DynamicResource BusBuddy.Brush.Text.Primary}"
                            AutomationProperties.Name="Add Student"
                            AutomationProperties.HelpText="Opens form to add a new student to the system"/>
            <!-- Edit selected student — enabled only when HasSelectedStudent is true. Command: EditStudentCommand -->
            <syncfusion:ButtonAdv Name="EditStudentButton" Label="✏️ Edit Student"
                            Command="{Binding EditStudentCommand}"
                            IsEnabled="{Binding HasSelectedStudent}"
                            AutomationProperties.Name="Edit Student"
                            AutomationProperties.HelpText="Opens form to edit the currently selected student"/>
            <!-- Delete selected student — enabled only when HasSelectedStudent is true. Command: DeleteStudentCommand -->
            <syncfusion:ButtonAdv Name="DeleteStudentButton" Label="🗑️ Delete Student"
                            Command="{Binding DeleteStudentCommand}"
                            IsEnabled="{Binding HasSelectedStudent}"
                            AutomationProperties.Name="Delete Student"
                            AutomationProperties.HelpText="Removes the currently selected student from the system"/>
                    <Separator Margin="10,0"/>

                    <!-- Bulk Operations -->
        <!-- Import students from CSV/Excel (placeholder) — Command: ImportStudentsCommand -->
        <syncfusion:ButtonAdv Name="ImportStudentsButton" Label="📥 Import CSV"
                            Command="{Binding ImportStudentsCommand}"
                Background="{DynamicResource BusBuddy.Brush.FleetGreen}" Foreground="{DynamicResource BusBuddy.Brush.Text.Primary}"
                            AutomationProperties.Name="Import Students from CSV"
                            AutomationProperties.HelpText="Import multiple students from a CSV file"/>
        <!-- Bulk assign route to selection — requires HasSelectedStudents. Command: BulkAssignRouteCommand -->
        <syncfusion:ButtonAdv Name="BulkAssignRouteButton" Label="🚌 Bulk Assign Route"
                            Command="{Binding BulkAssignRouteCommand}"
                            IsEnabled="{Binding HasSelectedStudents}"
                Background="{DynamicResource BusBuddy.Brush.SafetyOrange}" Foreground="{DynamicResource BusBuddy.Brush.Text.Primary}"
                            AutomationProperties.Name="Bulk Assign Route"
                            AutomationProperties.HelpText="Assign routes to multiple selected students at once"/>
                    <Separator Margin="10,0"/>

                    <!-- AI & Mapping -->
        <!-- Start AI optimization (placeholder). Command: OptimizeRoutesCommand -->
        <syncfusion:ButtonAdv Name="OptimizeRoutesButton" Label="🤖 AI Optimize"
                            Command="{Binding OptimizeRoutesCommand}"
                Background="{DynamicResource BusBuddy.Brush.Semantic.Warning}" Foreground="{DynamicResource BusBuddy.Brush.Text.Primary}"
                            AutomationProperties.Name="AI Optimize Routes"
                            AutomationProperties.HelpText="Use artificial intelligence to optimize route assignments"/>
        <!-- Plot all students on the map. Command: ViewMapCommand -->
        <syncfusion:ButtonAdv Name="ViewMapButton" Label="🗺️ View Map"
                            Command="{Binding ViewMapCommand}"
                Background="{DynamicResource BusBuddy.Brush.Semantic.Info}" Foreground="{DynamicResource BusBuddy.Brush.Text.Primary}"
                            AutomationProperties.Name="View Map"
                            AutomationProperties.HelpText="Display student locations on interactive map"/>
                </StackPanel>

                <!-- Quick Actions — utility commands (Refresh/Export) and quick search -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <syncfusion:ButtonAdv Name="RefreshButton" Label="🔄 Refresh"
                            Command="{Binding RefreshCommand}"
                            AutomationProperties.Name="Refresh Student List"
                            AutomationProperties.HelpText="Reload student data from the database"/>
                    <syncfusion:ButtonAdv Name="ExportButton" Label="📤 Export"
                            Command="{Binding ExportCommand}"
                            AutomationProperties.Name="Export Students"
                            AutomationProperties.HelpText="Export student data to CSV file"/>

                    <!-- Quick Filter using Syncfusion SfTextBoxExt per docs -->
                    <syncfusion:SfTextBoxExt Name="QuickSearchBox" Width="150" Margin="10,0,0,0"
                                              Text="{Binding QuickSearchText, UpdateSourceTrigger=PropertyChanged}"
                                              Watermark="\ud83d\udd0d Quick search..."
                                              AutomationProperties.Name="Quick Search"
                                              AutomationProperties.HelpText="Type to search students by name, ID, or route"/>
                </StackPanel>
            </Grid>
        </Border>

    <!-- Student Data Grid — Enhanced for route building (Syncfusion SfDataGrid per official docs) -->
    <syncfusion:SfDataGrid Grid.Row="2"
                               Name="StudentsDataGrid"
                   ItemsSource="{Binding StudentsView}"
                               SelectedItem="{Binding SelectedStudent, Mode=TwoWay}"
                               AutoGenerateColumns="False"
                               AllowEditing="True"
                               EditTrigger="OnTap"
                               AllowSorting="True"
                               AllowFiltering="True"
                               AllowGrouping="True"
                               ShowGroupDropArea="True"
                               ShowRowHeader="True"
                               SelectionMode="Single"
                               SelectionUnit="Row"
                               GridLinesVisibility="Both"
                               HeaderLinesVisibility="Both"
                               ColumnSizer="Star"
                               AutomationProperties.Name="Students Data Grid"
                               AutomationProperties.HelpText="Grid displaying all students with their route assignments and contact information"
                               AddNewRowPosition="Top"
                               ShowBusyIndicator="True"
                               NavigationMode="Cell"
                               AllowResizingColumns="True">

            <!-- Table Summary for Route Analytics -->
            <syncfusion:SfDataGrid.TableSummaryRows>
                <syncfusion:GridTableSummaryRow ShowSummaryInRow="False">
                    <syncfusion:GridTableSummaryRow.SummaryColumns>
                        <syncfusion:GridSummaryColumn Name="TotalStudents"
                                                    MappingName="StudentNumber"
                                                    SummaryType="CountAggregate"
                                                    Format="'Total: {Count:0}'" />
                        <syncfusion:GridSummaryColumn Name="ActiveCount"
                                                    MappingName="Active"
                                                    SummaryType="CountAggregate"
                                                    Format="'Active: {Count:0}'" />
                    </syncfusion:GridTableSummaryRow.SummaryColumns>
                </syncfusion:GridTableSummaryRow>
            </syncfusion:SfDataGrid.TableSummaryRows>

            <!-- Group Summary for Route Assignment Analysis -->
            <syncfusion:SfDataGrid.GroupSummaryRows>
                <syncfusion:GridSummaryRow ShowSummaryInRow="True">
                    <syncfusion:GridSummaryRow.SummaryColumns>
                        <syncfusion:GridSummaryColumn Name="GroupCount"
                                                    MappingName="StudentNumber"
                                                    SummaryType="CountAggregate"
                                                    Format="'{Count} students in this group'" />
                    </syncfusion:GridSummaryRow.SummaryColumns>
                </syncfusion:GridSummaryRow>
            </syncfusion:SfDataGrid.GroupSummaryRows>

            <syncfusion:SfDataGrid.Columns>
                <syncfusion:GridTextColumn HeaderText="Student ID"
                                         MappingName="StudentNumber"
                                         Width="100"
                                         AllowEditing="True"/>
                <syncfusion:GridTextColumn HeaderText="Name"
                                         MappingName="StudentName"
                                         Width="180"
                                         AllowEditing="True"/>
                <!-- Optional: Enrollment Date column using Pattern per Syncfusion docs -->
                <syncfusion:GridDateTimeColumn HeaderText="Enrolled"
                                             MappingName="EnrollmentDate"
                                             Width="110"
                                             Pattern="ShortDate"/>
                <syncfusion:GridComboBoxColumn HeaderText="Grade"
                                             MappingName="Grade"
                                             Width="80"
                                             ItemsSource="{Binding AvailableGrades}"
                                             AllowEditing="True"/>
                <syncfusion:GridComboBoxColumn HeaderText="School"
                                             MappingName="School"
                                             Width="150"
                                             ItemsSource="{Binding AvailableSchools}"
                                             AllowEditing="True"/>
                <syncfusion:GridTextColumn HeaderText="Address"
                                         MappingName="HomeAddress"
                                         Width="200"
                                         AllowEditing="True"/>
                <syncfusion:GridTextColumn HeaderText="City"
                                         MappingName="City"
                                         Width="120"
                                         AllowEditing="True"/>
                <!-- Phone number uses GridMaskColumn per Syncfusion documentation -->
                <syncfusion:GridMaskColumn HeaderText="Phone"
                                           MappingName="HomePhone"
                                           Width="120"
                                           AllowEditing="True"
                                           Mask="(###) ###-####"
                                           PromptChar="_" />
                <syncfusion:GridTextColumn HeaderText="Parent/Guardian"
                                         MappingName="ParentGuardian"
                                         Width="150"
                                         AllowEditing="True"/>
                <syncfusion:GridComboBoxColumn HeaderText="AM Route"
                                             MappingName="AMRoute"
                                             Width="120"
                                             ItemsSource="{Binding AvailableRoutes}"
                                             DisplayMemberPath="RouteName"
                                             AllowEditing="True"/>
                <syncfusion:GridComboBoxColumn HeaderText="PM Route"
                                             MappingName="PMRoute"
                                             Width="120"
                                             ItemsSource="{Binding AvailableRoutes}"
                                             DisplayMemberPath="RouteName"
                                             AllowEditing="True"/>
                <syncfusion:GridCheckBoxColumn HeaderText="Active"
                                             MappingName="Active"
                                             Width="80"/>
                <syncfusion:GridTemplateColumn HeaderText="Actions" Width="100" AllowFiltering="False" AllowSorting="False">
                    <syncfusion:GridTemplateColumn.CellTemplate>
                        <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <syncfusion:ButtonAdv Label="🗺️"
                                                          ToolTip="View on Map"
                                                          Command="{Binding DataContext.ViewOnMapCommand, RelativeSource={RelativeSource AncestorType=syncfusion:ChromelessWindow}}"
                                                          CommandParameter="{Binding}"
                                                          Width="28" Height="28" Margin="2"
                                                          AutomationProperties.Name="View Student On Map"/>
                                    <syncfusion:ButtonAdv Label="🎯"
                                                          ToolTip="AI Route Suggest"
                                                          Command="{Binding DataContext.SuggestRouteCommand, RelativeSource={RelativeSource AncestorType=syncfusion:ChromelessWindow}}"
                                                          CommandParameter="{Binding}"
                                                          Width="28" Height="28" Margin="2"
                                                          AutomationProperties.Name="Suggest Route For Student"/>
                                </StackPanel>
                        </DataTemplate>
                    </syncfusion:GridTemplateColumn.CellTemplate>
                </syncfusion:GridTemplateColumn>
            </syncfusion:SfDataGrid.Columns>
        </syncfusion:SfDataGrid>

    <!-- Enhanced Status Bar with Route Analytics -->
    <Border Grid.Row="3" Background="{DynamicResource BusBuddy.Brush.Surface.Light}"
                CornerRadius="3" Padding="10" Margin="0,10,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Statistics -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="📊 Students: " FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding TotalStudents}" FontWeight="Bold" Margin="0,0,15,0"/>
                    <TextBlock Text="✅ Active: " FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding ActiveStudents}" FontWeight="Bold" Margin="0,0,15,0"/>
                    <TextBlock Text="🚌 With Routes: " FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding StudentsWithRoutes}" FontWeight="Bold" Margin="0,0,15,0"/>
                    <TextBlock Text="⚠️ Unassigned: " FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding UnassignedStudents}" FontWeight="Bold" Margin="0,0,15,0"/>
                    <TextBlock Text="🎯 Selected: " FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding SelectedStudent.StudentName, FallbackValue='None'}" FontWeight="Bold"/>
                </StackPanel>

                <!-- Quick Actions & Filter Status -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock Text="| " Margin="0,0,6,0"/>
                    <TextBlock Text="Status: " FontStyle="Italic"/>
                    <TextBlock Text="{Binding StatusMessage}" Margin="4,0,10,0"/>
                    <TextBlock Text="{Binding FilterStatusText}" FontStyle="Italic" Margin="0,0,10,0"/>
                    <syncfusion:ButtonAdv Label="📋 Summary" Width="80" Height="25"
                            Command="{Binding ShowSummaryCommand}"
                            ToolTip="Show route assignment summary"/>
                    <syncfusion:ButtonAdv Label="⚡ Quick Actions" Width="100" Height="25" Margin="5,0,0,0"
                            Command="{Binding ShowQuickActionsCommand}"
                            ToolTip="Show quick action menu"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</syncfusion:ChromelessWindow>
