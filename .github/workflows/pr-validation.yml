name: ðŸšŒ BusBuddy PR Validation Pipeline

# Security: Restrict permissions to read-only by default
permissions:
  contents: read
  pull-requests: read
  checks: write
  statuses: write

on:
  pull_request:
    branches: [main, master, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  # Security: Remove workflow_dispatch inputs per CKV_GHA_7
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: 9.0.x
  SOLUTION_FILE: BusBuddy.sln
  BUILD_CONFIGURATION: Release

jobs:
  # ðŸ” PR Analysis and Validation
  pr-analysis:
    name: ðŸ” PR Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'

    outputs:
      should-run-ci: ${{ steps.analysis.outputs.should-run-ci }}
      is-draft: ${{ steps.analysis.outputs.is-draft }}
      has-code-changes: ${{ steps.analysis.outputs.has-code-changes }}
      change-summary: ${{ steps.analysis.outputs.change-summary }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Analyze PR changes
        id: analysis
        run: |
          echo "ðŸ” Analyzing PR changes..."

          # Check if PR is draft
          IS_DRAFT="${{ github.event.pull_request.draft }}"
          echo "is-draft=$IS_DRAFT" >> $GITHUB_OUTPUT

          # Get changed files
          CHANGED_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path')
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check for code changes (not just docs/markdown)
          CODE_CHANGES=$(echo "$CHANGED_FILES" | grep -E '\.(cs|csproj|sln|xaml|config|json|ps1|yml|yaml)$' || true)
          HAS_CODE_CHANGES="false"
          if [ -n "$CODE_CHANGES" ]; then
            HAS_CODE_CHANGES="true"
          fi
          echo "has-code-changes=$HAS_CODE_CHANGES" >> $GITHUB_OUTPUT

          # Determine if CI should run
          SHOULD_RUN_CI="true"
          if [ "$IS_DRAFT" = "true" ]; then
            SHOULD_RUN_CI="false"
            echo "â¸ï¸ Skipping CI for draft PR"
          elif [ "$HAS_CODE_CHANGES" = "false" ]; then
            SHOULD_RUN_CI="false"
            echo "â¸ï¸ Skipping CI - no code changes detected"
          fi
          echo "should-run-ci=$SHOULD_RUN_CI" >> $GITHUB_OUTPUT

          # Create change summary
          CHANGE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          echo "change-summary=Modified $CHANGE_COUNT files" >> $GITHUB_OUTPUT

          echo "âœ… PR analysis completed"
        env:
          GH_TOKEN: ${{ github.token }}

  # ðŸ—ï¸ Multi-platform Build and Test
  build-test-x64:
    name: ðŸ—ï¸ Build & Test (x64)
    needs: [pr-analysis]
    if: always() && (needs.pr-analysis.outputs.should-run-ci == 'true' || github.event_name == 'workflow_dispatch')
    uses: ./.github/workflows/reusable-build-test.yml
    with:
      dotnet-version: 9.0.x
      build-configuration: Release
      solution-file: BusBuddy.sln
      run-tests: true
      upload-artifacts: false
      target-platform: x64

  build-test-x86:
    name: ðŸ—ï¸ Build & Test (x86)
    needs: [pr-analysis]
    if: always() && (needs.pr-analysis.outputs.should-run-ci == 'true' || github.event_name == 'workflow_dispatch')
    uses: ./.github/workflows/reusable-build-test.yml
    with:
      dotnet-version: 9.0.x
      build-configuration: Release
      solution-file: BusBuddy.sln
      run-tests: true
      upload-artifacts: false
      target-platform: x86

  # ðŸŽ¯ Code Quality Gate
  quality-gate:
    name: ðŸŽ¯ Quality Gate
    runs-on: windows-latest
    needs: [pr-analysis]
    if: always() && (needs.pr-analysis.outputs.should-run-ci == 'true' || github.event_name == 'workflow_dispatch')
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ—ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¦ Restore dependencies
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: ðŸ” Code analysis
        run: |
          Write-Output "ðŸ” Running code analysis..."
          dotnet build ${{ env.SOLUTION_FILE }} --no-restore --configuration ${{ env.BUILD_CONFIGURATION }} --verbosity minimal

          # Check for build warnings
          $warnings = dotnet build ${{ env.SOLUTION_FILE }} --no-restore --configuration ${{ env.BUILD_CONFIGURATION }} --verbosity normal 2>&1 | Select-String "warning"
          if ($warnings) {
            Write-Output "âš ï¸ Build warnings detected:"
            $warnings | ForEach-Object { Write-Output $_ }
          } else {
            Write-Output "âœ… No build warnings detected"
          }

      - name: ðŸ§ª Validate tests
        run: |
          Write-Output "ðŸ§ª Validating test structure..."
          dotnet test ${{ env.SOLUTION_FILE }} --no-build --configuration ${{ env.BUILD_CONFIGURATION }} --list-tests --verbosity minimal
          Write-Output "âœ… Test validation completed"

  # ðŸ”’ Security Scan
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [pr-analysis]
    if: always() && (needs.pr-analysis.outputs.should-run-ci == 'true' || github.event_name == 'workflow_dispatch')
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”’ Run security scan
        run: |
          echo "ðŸ”’ Running security analysis..."

          # Check for sensitive files
          echo "ðŸ” Checking for sensitive files..."
          find . -name "*.key" -o -name "*.pem" -o -name "*.p12" -o -name "*.pfx" | grep -v node_modules || echo "âœ… No sensitive files found"

          # Check for hardcoded secrets (basic patterns)
          echo "ðŸ” Checking for potential secrets..."
          grep -r -E "(password|secret|key|token)\s*[:=]\s*['\"][^'\"]{8,}" --include="*.cs" --include="*.json" --include="*.config" . || echo "âœ… No obvious secrets found"

          echo "âœ… Security scan completed"

  # ðŸ“Š PR Status Summary
  pr-status-summary:
    name: ðŸ“Š PR Status Summary
    runs-on: ubuntu-latest
    needs: [pr-analysis, build-test-x64, build-test-x86, quality-gate, security-scan]
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: ðŸ“Š Generate PR status summary
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CHANGE_SUMMARY: ${{ needs.pr-analysis.outputs.change-summary || 'Unknown' }}
        run: |
          echo "## ðŸšŒ BusBuddy PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR #${PR_NUMBER}**: ${PR_TITLE}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes**: ${CHANGE_SUMMARY}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| PR Analysis | ${{ needs.pr-analysis.result == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.pr-analysis.outputs.is-draft == 'true' && 'Draft PR' || 'Ready for review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build (x64) | ${{ needs.build-test-x64.result == 'success' && 'âœ…' || needs.build-test-x64.result == 'skipped' && 'â¸ï¸' || 'âŒ' }} | ${{ needs.build-test-x64.outputs.build-success == 'true' && 'Build successful' || needs.build-test-x64.result == 'skipped' && 'Skipped' || 'Build failed' }} |" >> $GITHUB_STEP_SUMMARY
          # Build x86 status
          echo "| Build (x86) | ${{ needs.build-test-x86.result == 'success' && 'âœ…' || needs.build-test-x86.result == 'skipped' && 'â¸ï¸' || 'âŒ' }} | ${{ needs.build-test-x86.result == 'skipped' && 'Skipped' || 'Completed' }} |" >> $GITHUB_STEP_SUMMARY

          # Test results
          echo "| Tests (x64) | ${{ needs.build-test-x64.result == 'success' && 'âœ…' || needs.build-test-x64.result == 'skipped' && 'â¸ï¸' || 'âŒ' }} | Coverage: ${{ needs.build-test-x64.outputs.coverage-percentage || '0' }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests (x86) | ${{ needs.build-test-x86.result == 'success' && 'âœ…' || needs.build-test-x86.result == 'skipped' && 'â¸ï¸' || 'âŒ' }} | Coverage: ${{ needs.build-test-x86.outputs.coverage-percentage || '0' }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gate | ${{ needs.quality-gate.result == 'success' && 'âœ…' || needs.quality-gate.result == 'skipped' && 'â¸ï¸' || 'âŒ' }} | Code analysis and validation |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-scan.result == 'success' && 'âœ…' || needs.security-scan.result == 'skipped' && 'â¸ï¸' || 'âŒ' }} | Security analysis |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          ALL_SUCCESS="true"
          if [[ "${{ needs.build-test-x64.result }}" != "success" && "${{ needs.build-test-x64.result }}" != "skipped" ]]; then ALL_SUCCESS="false"; fi
          if [[ "${{ needs.build-test-x86.result }}" != "success" && "${{ needs.build-test-x86.result }}" != "skipped" ]]; then ALL_SUCCESS="false"; fi
          if [[ "${{ needs.quality-gate.result }}" != "success" && "${{ needs.quality-gate.result }}" != "skipped" ]]; then ALL_SUCCESS="false"; fi
          if [[ "${{ needs.security-scan.result }}" != "success" && "${{ needs.security-scan.result }}" != "skipped" ]]; then ALL_SUCCESS="false"; fi

          if [[ "$ALL_SUCCESS" == "true" ]]; then
            echo "## âœ… All checks passed! This PR is ready for review and merge." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Some checks failed. Please review and fix the issues before merging." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ’¬ Update PR status comment
        if: github.event_name == 'pull_request'
        run: |
          # Create or update a status comment on the PR
          COMMENT_BODY="## ðŸšŒ BusBuddy CI Pipeline Status

          **Latest run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          **Commit**: ${{ github.sha }}

          | Check | Status |
          |-------|--------|
          | Build (x64) | ${{ needs.build-test-x64.result == 'success' && 'âœ… Passed' || needs.build-test-x64.result == 'skipped' && 'â¸ï¸ Skipped' || 'âŒ Failed' }} |
          | Build (x86) | ${{ needs.build-test-x86.result == 'success' && 'âœ… Passed' || needs.build-test-x86.result == 'skipped' && 'â¸ï¸ Skipped' || 'âŒ Failed' }} |
          | Quality Gate | ${{ needs.quality-gate.result == 'success' && 'âœ… Passed' || needs.quality-gate.result == 'skipped' && 'â¸ï¸ Skipped' || 'âŒ Failed' }} |
          | Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || needs.security-scan.result == 'skipped' && 'â¸ï¸ Skipped' || 'âŒ Failed' }} |

          > This comment is automatically updated with the latest CI status."

          # Find existing comment
          EXISTING_COMMENT=$(gh pr view ${{ github.event.pull_request.number }} --json comments --jq '.comments[] | select(.body | startswith("## ðŸšŒ BusBuddy CI Pipeline Status")) | .id' | head -1)

          if [ -n "$EXISTING_COMMENT" ]; then
            echo "Updating existing comment: $EXISTING_COMMENT"
            gh api repos/${{ github.repository }}/issues/comments/$EXISTING_COMMENT -X PATCH -f body="$COMMENT_BODY"
          else
            echo "Creating new status comment"
            gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT_BODY"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
