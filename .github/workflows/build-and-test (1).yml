name: ðŸšŒ Bus Buddy CI/CD Pipeline

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: "Enable debug mode for troubleshooting"
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: "9.0.x"
  SOLUTION_FILE: "BusBuddy.sln"
  BUILD_CONFIGURATION: "Release"

jobs:
  build-and-test:
    runs-on: windows-latest
    timeout-minutes: 30

    outputs:
      build-success: ${{ steps.build-step.outcome == 'success' }}
      test-success: ${{ steps.test-step.outcome == 'success' }}
      coverage-percentage: ${{ steps.coverage-step.outputs.coverage || '0' }}
      build-time: ${{ steps.timing.outputs.build-time || '0' }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Enable GitVersion and better diff analysis

      - name: â±ï¸ Start timing
        id: timing
        run: |
          echo "start-time=$(date -u +%s)" >> $GITHUB_OUTPUT
          echo "ðŸ• Workflow started at $(Get-Date)"

      - name: ðŸ—ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¦ Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ${{ github.workspace }}/**/obj/project.assets.json
            ${{ github.workspace }}/**/obj/*.csproj.nuget.*
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ðŸ”§ Restore dependencies
        run: |
          echo "ðŸ”„ Restoring NuGet packages..."
          dotnet restore ${{ env.SOLUTION_FILE }} --verbosity normal
          echo "âœ… Package restoration completed"

      - name: ðŸ—ï¸ Build solution
        id: build-step
        run: |
          echo "ðŸ”¨ Building Bus Buddy solution..."
          dotnet build ${{ env.SOLUTION_FILE }} --no-restore --configuration ${{ env.BUILD_CONFIGURATION }} --verbosity normal
          echo "âœ… Build completed successfully"

      - name: ðŸ§ª Run tests
        id: test-step
        run: |
          echo "ðŸ§ª Running comprehensive test suite..."
          dotnet test ${{ env.SOLUTION_FILE }} --no-build --configuration ${{ env.BUILD_CONFIGURATION }} --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./TestResults --logger trx --settings testsettings.runsettings
      - name: ðŸ“Š Generate coverage report
        id: coverage-step
        run: |
          echo "ðŸ“Š Generating coverage reports..."

          # Find coverage files
          $coverageFiles = Get-ChildItem -Path "./TestResults" -Filter "coverage.cobertura.xml" -Recurse

          if ($coverageFiles.Count -gt 0) {
            # Extract coverage percentage (simplified - you might want more sophisticated parsing)
            $coverageFile = $coverageFiles[0].FullName
            [xml]$coverage = Get-Content $coverageFile
            $lineRate = [double]$coverage.coverage.'line-rate'
            $coveragePercent = [math]::Round($lineRate * 100, 2)

            echo "coverage=$coveragePercent" >> $env:GITHUB_OUTPUT
            echo "âœ… Coverage: $coveragePercent%"
          } else {
            echo "coverage=0" >> $env:GITHUB_OUTPUT
            echo "âš ï¸ No coverage files found"
          }


          echo ""
          echo "ðŸ“ Coverage files location: ./TestResults/**/coverage.cobertura.xml"

          # List actual coverage files found
          $coverageFiles = Get-ChildItem -Path "./TestResults" -Filter "*.xml" -Recurse -ErrorAction SilentlyContinue
          if ($coverageFiles.Count -gt 0) {
            echo "ðŸ“‹ Found coverage files:"
            foreach ($file in $coverageFiles) {
              echo "   - $($file.FullName)"
            }
          } else {
            echo "âš ï¸ No coverage files found in TestResults directory"
          }

      - name: ðŸ“Š Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: "Test Results"
          path: "**/TestResults/*.trx"
          reporter: "dotnet-trx"
          fail-on-error: false

      - name: ðŸ“¦ Archive build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-artifacts-${{ github.run_number }}
          path: |
            **/bin/Release/
            **/TestResults/
            **/*.log
          retention-days: 7

      - name: ðŸ“¦ Archive test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-failure-logs-${{ github.run_number }}
          path: |
            **/logs/
            **/TestResults/
            **/*.trx
          retention-days: 14

      - name: â±ï¸ Calculate build time
        if: always()
        run: |
          $startTime = "${{ steps.timing.outputs.start-time || '0' }}"
          $endTime = [int][double]::Parse((Get-Date -UFormat %s))
          if ($startTime -ne "0") {
            $buildTime = $endTime - [int]$startTime
          } else {
            $buildTime = 0
          }
          echo "build-time=$buildTime" >> $env:GITHUB_OUTPUT
          echo "ðŸ• Total build time: ${buildTime} seconds"

      - name: ðŸ“ Create build summary
        if: always()
        run: |
          echo "## ðŸšŒ Bus Buddy Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Status | ${{ steps.build-step.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Status | ${{ steps.test-step.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ steps.coverage-step.outputs.coverage || '0' }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Time | ${{ steps.timing.outputs.build-time || '0' }}s |" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | ${{ env.BUILD_CONFIGURATION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| .NET Version | ${{ env.DOTNET_VERSION }} |" >> $GITHUB_STEP_SUMMARY

  # Security scanning job
  security-scan:
    runs-on: windows-latest
    if: github.event_name == 'push'
    needs: build-and-test

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: csharp

      - name: ðŸ—ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¦ Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ${{ github.workspace }}/**/obj/project.assets.json
            ${{ github.workspace }}/**/obj/*.csproj.nuget.*
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ðŸ”§ Restore and build for analysis
        run: |
          echo "ðŸ”§ Restoring packages for security analysis..."
          dotnet restore ${{ env.SOLUTION_FILE }}
          echo "ðŸ”¨ Building for CodeQL analysis..."
          dotnet build ${{ env.SOLUTION_FILE }} --no-restore --configuration Release

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # Dependency vulnerability scanning
  dependency-scan:
    runs-on: windows-latest
    if: github.event_name == 'push'
    needs: build-and-test

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ” Run dependency vulnerability scan
        id: vuln-scan
        run: |
          echo "ðŸ” Scanning for vulnerable dependencies..."
          dotnet list package --vulnerable --include-transitive > vulnerability-report.txt 2>&1
          $vulnerableCount = (Select-String -Path vulnerability-report.txt -Pattern "has the following vulnerable packages" | Measure-Object).Count

          if ($vulnerableCount -gt 0) {
            echo "âš ï¸ Found $vulnerableCount vulnerable packages:"
            Get-Content vulnerability-report.txt
            echo "vulnerable-packages=$vulnerableCount" >> $env:GITHUB_OUTPUT
          } else {
            echo "âœ… No vulnerable packages found"
            echo "vulnerable-packages=0" >> $env:GITHUB_OUTPUT
          }

      - name: ðŸ“¦ Upload vulnerability report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerability-report-${{ github.run_number }}
          path: vulnerability-report.txt
          retention-days: 30

      - name: ðŸ“Š Create security summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Vulnerable Packages | ${{ steps.vuln-scan.outputs.vulnerable-packages || '0' }} |" >> $GITHUB_STEP_SUMMARY
